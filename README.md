# prepare deploy

![GitHub action](https://github.com/dictybase-docker/prepare-deploy/workflows/build-test/badge.svg)

The `dictybase-docker/prepare-deploy` is a javascript action that triggers a [github deployment](https://developer.github.com/v3/repos/deployments/#create-a-deployment)
for the same repository. The action is mainly designed to work with the following assumption..
- For deploying in cloud hosted (such as gke, azure etc) `kubernetes` cluster. Defaults to `gke`.
- The code will be deployed using [helm](https://helm.sh).
- The `helm` chart exists in the same repository.
- The deployment event generated by this action is expected to be captured by another github workflow to deploy the actual software.

## Usage
The action can be run in any of the provided [vms](https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners#supported-runners-and-hardware-resources), however `ubuntu-latest` is recommended. 

```yaml
steps:
  - name: prepare for deploy
    uses: dictybase-docker/prepare-deploy@v1
    with:
      cluster-name: staging
      namespace: dictybase
      chart-name: event-manager
      chart-path: deployment/chart/event-email
      image-tag: sha-4839d84a
      ref: 483fjke81 #(or v1.2.3 or feat/hot-fuzz etc.)
      token: ${{ github.token }}
```
It is recommended to run it after a test and build jobs(CI), for example...
```yaml
name: Continuous build and prepare deploy
on: 
 push:
   branches:
     - develop
jobs:
  test:
    runs-on: ubuntu-18.04
    steps:
      - name: check out code
        uses: actions/checkout@v2
      - name: unit test
        run: 'some test comamnd' 
  build:
    needs: test
    runs-on: ubuntu-18.04
    steps:
      - name: check out code
        uses: actions/checkout@v2
         name: image build and push
        uses: docker/build-push-action@v1
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD  }}
          repository: dictybase/auto-deploy
          add_git_labels: true
          tag_with_sha: true
      - name: prepare for deploy
        uses: dictybase-docker/prepare-deploy@v1
        with:
          cluster-name: staging
          namespace: dictybase
          # rest of it 
```

## Inputs
The following inputs are supported.

- `cluster-name` - (required) The name of kubernetes cluster where the code will be deployed.

- `namespace` - (required) The name of kubernetes namespace.

- `cluster-zone` - (optional) The cloud zone where the cluster is deployed. Defaults to `us-central1-a` for a gke cluster. 

- `chart-name` - (required) The name of helm chart to be deployed.

- `chart-path` - (required) The chart location  path relative to the root of the repository.

- `image-tag` - (required) Docker image tag that will be deployed.

- `ref` - (required) The name of a specific git branch, sha or tag that will be deployed.

- `token` - (required) Github token for authentication.

## Outputs
The following outputs are supported.

- `create-deploy` - The url for newly created deployment.