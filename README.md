# prepare deploy

[![License](https://img.shields.io/badge/License-BSD%202--Clause-blue.svg)](LICENSE)   
![Continuous integration](https://github.com/dictybase-docker/prepare-deploy/workflows/Continuous%20integration/badge.svg)
[![Dependabot Status](https://api.dependabot.com/badges/status?host=github&repo=dictybase-docker/prepare-deploy)](https://dependabot.com)   
![Issues](https://badgen.net/github/issues/dictybase-docker/prepare-deploy)
![Open Issues](https://badgen.net/github/open-issues/dictybase-docker/prepare-deploy)
![Closed Issues](https://badgen.net/github/closed-issues/dictybase-docker/prepare-deploy)   
![Total PRS](https://badgen.net/github/prs/dictybase-docker/prepare-deploy)
![Open PRS](https://badgen.net/github/open-prs/dictybase-docker/prepare-deploy)
![Closed PRS](https://badgen.net/github/closed-prs/dictybase-docker/prepare-deploy)
![Merged PRS](https://badgen.net/github/merged-prs/dictybase-docker/prepare-deploy)   
![Commits](https://badgen.net/github/commits/dictybase-docker/prepare-deploy/develop)
![Last commit](https://badgen.net/github/last-commit/dictybase-docker/prepare-deploy/develop)
![Branches](https://badgen.net/github/branches/dictybase-docker/prepare-deploy)
![Tags](https://badgen.net/github/tags/dictybase-docker/prepare-deploy/?color=cyan)   
![GitHub repo size](https://img.shields.io/github/repo-size/dictybase-docker/prepare-deploy?style=plastic)
![GitHub code size in bytes](https://img.shields.io/github/languages/code-size/dictybase-docker/prepare-deploy?style=plastic)   
[![Funding](https://badgen.net/badge/NIGMS/Rex%20L%20Chisholm,dictyBase/yellow?list=|)](https://projectreporter.nih.gov/project_info_description.cfm?aid=9476993)
[![Funding](https://badgen.net/badge/NIGMS/Rex%20L%20Chisholm,DSC/yellow?list=|)](https://projectreporter.nih.gov/project_info_description.cfm?aid=9438930)


The `dictybase-docker/prepare-deploy` is a javascript action that triggers a [github deployment](https://developer.github.com/v3/repos/deployments/#create-a-deployment)
for the same repository. The action is mainly designed to work with the following assumption..

- For deploying in cloud hosted (such as gke, azure etc) `kubernetes` cluster. Defaults to `gke`.
- The code will be deployed using [helm](https://helm.sh).
- The `helm` chart exists in the same repository.
- The deployment event generated by this action is expected to be captured by another github workflow to deploy the actual software.

## Usage
The action can be run in any of the provided [vms](https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners#supported-runners-and-hardware-resources), however `ubuntu-latest` is recommended. 

```yaml
steps:
  - name: prepare for deploy
    uses: dictybase-docker/prepare-deploy@v1
    with:
      cluster-name: staging
      namespace: dictybase
      chart-name: event-manager
      chart-path: deployment/chart/event-email
      image-tag: sha-4839d84a
      ref: 483fjke81 #(or v1.2.3 or feat/hot-fuzz etc.)
      token: ${{ github.token }}
```

It is recommended to run it after a test and build jobs(CI), for example...

```yaml
name: Continuous build and prepare deploy
on: 
 push:
   branches:
     - develop
jobs:
  test:
    runs-on: ubuntu-18.04
    steps:
      - name: check out code
        uses: actions/checkout@v2
      - name: unit test
        run: 'some test comamnd' 
  build:
    needs: test
    runs-on: ubuntu-18.04
    steps:
      - name: check out code
        uses: actions/checkout@v2
         name: image build and push
        uses: docker/build-push-action@v1
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD  }}
          repository: dictybase/auto-deploy
          add_git_labels: true
          tag_with_sha: true
  prepare-deploy:
    needs: build
    runs-on: ubuntu-18.04
    steps:
      - name: create deploy event
        uses: dictybase-docker/prepare-deploy@v1
        with:
          cluster-name: staging
          namespace: dictybase
          # rest of it 
```

## Inputs

The following inputs are supported.

- `cluster-name` - (required) The name of kubernetes cluster where the code will be deployed.

- `namespace` - (required) The name of kubernetes namespace.

- `cluster-zone` - (optional) The cloud zone where the cluster is deployed. Defaults to `us-central1-a` for a gke cluster. 

- `chart-name` - (required) The name of helm chart to be deployed.

- `chart-path` - (required) The chart location  path relative to the root of the repository.

- `image-tag` - (required) Docker image tag that will be deployed.

- `ref` - (required) The name of a specific git branch, sha or tag that will be deployed.

- `token` - (required) Github token for authentication.

- `owner` - (required) Owner of the GitHub repository. (i.e. dictyBase)

- `repo` - (required) Name of the GitHub repository. (i.e. dicty-frontpage)

- `environment` - (optional) Runtime environment name. Default to development.

- `artifact` - Name of upload artifact containing a file with the deployment payload. 
               It can be accessed with [download artifact action](https://github.com/actions/download-artifact) within the same workflow. The name defaults to `deploy-payload` 



## Outputs

The following outputs are supported.

- `deployment-response` - Contain deployment payload in the output which can be accessed in any 
                          successive step in the same job. 
- `upload-response` - Contain [upload artifact payload](https://github.com/actions/toolkit/tree/master/packages/artifact#upload-result) to be accessed in any successive step within the same job.

## Active Developers

<a href="https://sourcerer.io/cybersiddhu"><img src="https://sourcerer.io/assets/avatar/cybersiddhu" height="80px" alt="Sourcerer"></a>
<a href="https://sourcerer.io/wildlifehexagon"><img src="https://sourcerer.io/assets/avatar/wildlifehexagon" height="80px" alt="Sourcerer"></a>